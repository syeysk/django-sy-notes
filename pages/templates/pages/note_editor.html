{% extends 'template.html' %}
{% load markdownify %}
{% load static %}

{% block title %}{{ note.title }}{% endblock %}
{% block page_title %} Заметка | {{ note.title }}{% endblock %}

{% block start_of_head %}
    <script src="{% static 'base/extern/codemirror-5.65.14/lib/codemirror.js' %}"></script>
    <link rel="stylesheet" href="{% static 'base/extern/codemirror-5.65.14/lib/codemirror.css' %}">
    <link rel="stylesheet" href="{% static 'base/extern/codemirror-5.65.14/theme/default.css' %}">
    <script src="{% static 'base/extern/codemirror-5.65.14/mode/markdown/markdown.js' %}"></script>
    <script src="{% static 'base/extern/codemirror-5.65.14/mode/python/python.js' %}"></script>
{% endblock %}

{% block content %}
    {{ note|json_script:'note_json' }}

    <div id="app_note_id"></div>
{% endblock %}

{% block end_of_body %}
    <style>
        .CodeMirror {
            width: 99%;
            height: 61vh;
        }
		</style>

    <script>
        var URL_SAVE_NOTE = '';
        var CSRF_TOKEN = "{{ csrf_token }}";

        function update_page(title) {
            $('body h1')[0].textContent = title;
        }
    </script>

    <script>
        CodeMirrorComponent = {
            props: ['modelValue'],
            emits: ['update:modelValue'],
            data() {
                console.log(this.$el);
                return {
                    noteCodeMirror: undefined,
                };
            },
            computed: {
                value: {
                    get() {
                        return this.modelValue;
                    },
                    set(value) {
                        this.$emit('update:modelValue', value);
                    },
                }
            },
            template: `<textarea v-model="value"></textarea>`,
            mounted() {
                this.noteCodeMirror = CodeMirror.fromTextArea(
                    this.$el,
                    {theme: "default", lineNumbers: true, mode: "markdown", extraKeys: {"Enter": "newlineAndIndentContinueMarkdownList"}}
                );
                let self = this;
                this.noteCodeMirror.getDoc().on(
                    'change',
                    function(doc) {self.value = doc.getValue();},
                );
            },
        }
    </script>

    <script>
        NoteViewerComponent = {
            props: ['content_html'],
            template: `<div v-html="content_html"></div>`,
        }
    </script>

    <script>
        NoteEditorComponent = {
            props: ['title', 'content', 'errorMessage', 'successMessage'],
            emits: ['save', 'cancel'],
            data() {
                return {mTitle: this.title, mContent: this.content}
            },
            components: {CodeMirrorComponent},
            template: `
                <form>
                    <input name="source" type="hidden" value="{{ source }}">
                    <input name="title" v-model="mTitle" style="width:99%;">
                    <br><br>
                    <code-mirror-component v-model="mContent" name="content"></code-mirror-component>
                    <br>
                    <div :class="{'d-none': !errorMessage}">
                        <span>[[ errorMessage ]]</span>
                        <br>
                    </div>
                    <div :class="{'d-none': !successMessage}">
                        <span>[[ successMessage ]]</span>
                        <br>
                    </div>
                    <input type="button" value="Сохранить" @click="save">
                    <input type="button" value="Отменить" @click="cancel">
                </form>
            `,
            methods: {
                save(event) {
                    this.$emit('save', event, this.mTitle, this.mContent);
                },
                cancel(event) {
                    this.$emit('cancel', event, this, this.mTitle, this.mContent);
                },
            },
        }
    </script>

    <script>
        NoteComponent = {
            template: `
                <input type="button" value="Edit" @click="edit" :class="{'d-none': mode == 'edit'}">
                <note-viewer-component
                    :class="{'d-none': mode == 'edit'}"
                    :content_html="content_html"
                ></note-viewer-component>
                <note-editor-component
                    v-if="mode != 'view'"
                    :title="title"
                    :content="content"
                    :error-message="errorMessage"
                    :success-message="successMessage"
                    @save="save"
                    @cancel="cancel"
                ></note-editor-component>
            `,
            components: {NoteViewerComponent, NoteEditorComponent},
            data() {
                return {
                    title: note_object.title,
                    content: note_object.content,
                    content_html: note_object.content_html,
                    errorMessage: '',
                    successMessage: '',
                    mode: 'view',
                }
            },
            methods: {
                edit() {
                    this.mode = 'edit';
                },
                view() {
                    this.mode = 'view';
                },
                cancel(event, editor, title, content) {
                    editor.mTitle = this.title;
                    editor.mContent = this.content;
                    this.view();
                },
                save(event, title, content) {
                    let self = this;
                    this.successMessage = 'Сохраняем...'
                    $.ajax({
                        url: URL_SAVE_NOTE,
                        headers: {
                            "X-CSRFToken": CSRF_TOKEN,
                        },
                        dataType: 'json',
                        data: {new_title: title, new_content: content, title: self.title},
                        success: function(result) {
                            set_valid_field(event.target.form, result.updated_fields);
                            self.successMessage = '';
                            history.pushState(
                                null,
                                null,
                                location.href.replace('/' + encodeURI(self.title), '/' + encodeURI(title)),
                            );
                            self.title = title;
                            self.content = content;
                            self.content_html = result.content_html;
                            update_page(title);
                            self.view();
                        },
                        statusCode: {
                            500: function(xhr) {
                                self.errorMessage = 'ошибка сохранения'
                            },
                            400: function(xhr) {
                                set_invalid_field(event.target.form, xhr.responseJSON);
                                self.errorMessage = 'сохранение в разработке...'
                            },
                            404: function(xhr) {
                                self.errorMessage = 'заметка с таким именем не существует'
                            },
                        },
                        method: "post"
                    });
                }
            },
        }
    </script>

    <script>
        var note_object = JSON.parse(document.getElementById('note_json').textContent);
        const { createApp } = Vue;

        var app_note = createApp(NoteComponent);
        app_note.config.compilerOptions.delimiters = [ '[[', ']]' ];
        var app_note_list = app_note.mount('#app_note_id');
    </script>
{% endblock %}
